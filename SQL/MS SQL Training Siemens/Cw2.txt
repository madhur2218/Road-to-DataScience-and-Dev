-- built-in functions --
-- scalar functions/single row function --- for every i/p we get 1 o/p
-- character, numeric, date, conversion, generic
select lower(ename) from emp;
select lower('Siemens') 
select UPPER(ename), LOWER(ename),LEN(ename),
LEFT(ename,3), RIGHT(ename,3), SUBSTRING(ename, 2, 3),
REPLACE(ename, 's','$'),CHARINDEX('s',ename), REVERSE (ename), concat(ename,job) from emp;
select  left('xyz@siemens.com',charindex('@','xyz@siemens.com')-1)
select left('manjunath@siemens.com',charindex('@','manjunath@siemens.com')-1)
select charindex('@','manjunath@siem@ens.com',11)
-- numeric 
select ABS(-10), SIGN(-200), POWER(2, 3), SQRT(64), ROUND(123.678,2), FLOOR(1.999), CEILING(1.002)
-- date
select GETDATE()
select DATEADD(MONTH,2,GETDATE())
select hiredate,dateadd(day,2,hiredate) from emp;
select MONTH(getdate()), YEAR(getdate()),DAY(getdate())
select DATEDIFF(month, hiredate,getdate()) from emp;
select DATEDIFF (year,hiredate,getdate())  as empexp from emp;
select DATEDIFF(day,hiredate,getdate()) from emp
select DATENAME(month, getdate()), DATENAME(dw,getdate());
select datename(dayofyear,getdate()),datename(week,getdate()),datename(hour,getdate());
select datename(weekday,getdate()),datename(quarter,getdate())
select DATEPART(year, getdate()),DATEPART(month, getdate())
select datepart(week,getdate()),datepart(weekday,getdate())
-- conversion 
SELECT CAST(14.85 AS int);
SELECT CAST(14.85 AS float);
SELECT CAST('2014-05-02' AS datetime);
-- convert(datatype size, exp,format)
SELECT CONVERT(int, 14.85);
SELECT CONVERT(float, 14);
SELECT CONVERT(float, '15.6');
SELECT CONVERT(datetime, '2014-05-02');
SELECT CONVERT(varchar, getdate(), 103);
SELECT CONVERT(varchar, getdate(), 104), CONVERT(varchar, getdate(), 107), CONVERT(varchar, getdate(), 108);
select CONVERT(char(10),getdate(), 112)
 select CONVERT(char(40),getdate(), 111)
 select CONVERT(char(25),getdate(), 100)
 -- generic
 select empno,ename,sal,comm,isnull(comm,10) newcomm from emp;
  select empno,ename,sal,comm,isnull(convert(varchar,comm),'N/A') newcomm from emp;
 ----------------------------------------------------------------------------------------------------------------------------
 select empno,ename,deptno,case deptno
  when 10 then 'A'
  when 20 then 'B'
  else 'X' end as empgrade from emp;
-- based on the sal dispaly a grade --
select empno,ename,job,sal,
case
when sal between 500 and 1000  then 'Agrade'
when sal between 1001 and 3000 then 'Bgrade'
else 'Xgrade' end as empgrade from emp;

-- group functions/ aggregate function
-- n i/p we get 1  i/p
-- sum, min,max,avg, count
select sum(sal) , min(sal), max(hiredate) from emp;
-- get the total  sal paid for emp in dept 20,30
select sum(sal) from emp where deptno in(20,30);
-- get the total paid for emp who earn comm
select sum(sal) from emp where comm is not null;
select sum(sal),ename from emp;
select avg(comm) , sum(comm)/14 from emp;
select sum(comm), min(comm), max(comm) from emp;
select count(*) thct, count(mgr) tmgrct, count(comm) tcmct, count(distinct job) jct from emp;
-- get the headcount of clerk
select count(*) from emp where job='clerk';
-- how many salesman earn comm
select count(*) from emp where job='salesman' and comm is not null;

select count(comm) from emp where job='salesman';
select * from emp;
-- get the headcount in each job -- grouping of data-- (group by )
select job,count(*) as hct from emp group by job;
-- get jobwise headcount excluding emp who earn sal<1000
select job,count(*) as hct from emp 
where sal>1000
group by job
order by job;
-- get deptwise min(sal), max(sal)
select deptno, min(sal) misal, max(sal) masal from emp 
group by deptno
order by deptno;
-- get deptwise min(sal), max(sal) excluding emp who do not have a manager
select deptno, min(sal) misal, max(sal) masal from emp 
where mgr is not null
group by deptno
order by deptno;
-- get deptwise min(sal), max(sal) excluding emp who do not have a manager only if min(sal) is>1000
select deptno, min(sal) misal, max(sal) masal from emp 
where mgr is not null -- 1
group by deptno  --2
having min(sal)>1000 --3
order by deptno; -- 5
-- get deptwise jobwise headcount
select deptno, job,count(*) hct from emp group by deptno,job order by deptno;
-- get mgrwise count of reportees
  mgr   hct
  select  mgr, count(*)  hct from emp  where mgr is not null group by mgr;

-- get an output as below (yearly count of emp joining the company)
  YOJ       HCT
  1980    2
     select year(hiredate) YOJ, count(*) HCT from emp group by year(hiredate)
	 order by yoj;
------------------------------------------------------------------------------------------------
--- joins ---
-- single select query written to fetch data from multiple tables
-- join operation is performed based on join criteria
-- join (n) tables---- (n-1) join criteria
-- pk-fk, col with same name, cols with same data

-- list empno,ename,sal,deptno,dname 
select * from emp;
select * from dept;
select empno,ename,sal,dept.deptno,dname from emp, dept where emp.deptno=dept.deptno;
-- table alias names
select e.empno,e.ename,e.sal,d.deptno,d.dname from emp e, dept d where e.deptno=d.deptno;
-- ANSI Joins  (join, on, inner, outer)
-- inner join-- return results matching the criteria
-- outer join -- return results matching the criteria + non matched records
select e.empno,e.ename,e.sal,d.deptno,d.dname from emp e join dept d on e.deptno=d.deptno;
-- list empno,ename,sal,deptno,dname of emp with sal>2000
select e.empno,e.ename,e.sal,d.deptno,d.dname from emp e inner join dept d on e.deptno=d.deptno 
where e.sal>2000;
select * from salgrade;
-- list emp with respective salgrade
select empno,ename,sal,grade from emp e join salgrade s on e.sal between s.losal and s.hisal;

-- 3 table join  (emp,dept,salgrade)
select e.empno,e.ename,d.deptno,d.dname,e.sal,s.grade from emp e join dept d on e.deptno=d.deptno
join  salgrade s on e.sal between s.losal and s.hisal where d.loc='chicago';

-- outer join -- return results matching the criteria + non matched records 
-- LOJ, ROJ, FOL
select empno,ename,sal,grade from emp e  left outer  join salgrade s on e.sal between s.losal and s.hisal;
select e.empno,e.ename,e.sal,d.deptno,d.dname from emp e right outer join dept d on e.deptno=d.deptno;
-- self join (table joining with self)- PK-FK mapping within the same table
-- list ename , managername
select * from emp;
select   e.ename, m.ename managername from emp e join emp m on e.mgr=m.empno;
-- list  all ename , managername
select   e.ename, isnull(m.ename,'NONE')  managername from emp e left  join emp m on e.mgr=m.empno;
-- cross join (cartesian product) (m*n)-- cross product
select ename, dname from emp cross join dept;
-- full outrer join  (m+n), cross join (m*n)
-- t1--- m, t2--n  o/p not be >(m+n) if o/p> (m+n) then join criteria missing, wrong join criteria
-- nested query/ sub query
-- list all emp who are junior to  FORD
select * from emp where hiredate>(select hiredate from emp where ename='FORD');
select * from emp where hiredate>(select hiredate from emp where ename='FOR');
-- types of subquery (single row (=,>,<,>=,<=,!=) multi row (IN, ALL, ANY (>ALL,<ALL,>ANY,<ANY))
-- main query oper (sub query)
-- lis all emp who earn sal > max(sal) among clerk
  select * from emp where sal>(select max(sal) from emp where job='clerk');
  -- list all emp who work in chicago
  select * from emp where deptno =(select deptno from dept where loc='chicago');
  -- list all emp who report to Blake's manager
   select * from emp where mgr= (select mgr from emp where ename='Blake') and ename!='Blake';
   -- list the details of the dept which has >3 emp working in it
  select * from dept where deptno in(select deptno  from emp group by deptno having count(*)>3);
  -- list all emp who earn sal> avg(sal) of any of the dept
    select * from emp where sal>any( select avg(sal) from emp group by deptno);
  -- list all emp who  work with Blake and report to Ford's manager
  -- multiple subquery
   select * from emp where deptno=(select deptno from emp where ename='Ford') and
   mgr= (select mgr from emp where ename='Ford') and ename!='Ford';
   	  -- correlated subquery
	  -- list all emp who earn sal> avg(sal) of  their respective dept
	  	  select * from emp e1 where sal>(select avg(sal) from emp e2 where e1.deptno=e2.deptno);
select deptno,avg(sal) from emp group by deptno;
-- inline view
select e.* from emp  e join ( select deptno,avg(sal)  asal from emp group by deptno) x 
on e.deptno=x.deptno and e.sal> x.asal;

-- CTE /with query/ common table expression
 with xyz as ( select deptno,avg(sal)  asal from emp group by deptno)
 select e.* from emp  e join xyz x  on e.deptno=x.deptno and e.sal> x.asal;

 -- exists (returns true/false) when true- main query executes, when false-main query does not execute
 select * from dept where not exists( select ename from emp  where job='Ana');
  select * from dept where exists( select ename from emp  where job='Analyst');